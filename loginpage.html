<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Auth Demo</title>
    <style>
        :root{--accent:#2b6cb0;--danger:#e53e3e;--success:#2f855a}
        *{box-sizing:border-box}
        body{font-family:Arial,Helvetica,sans-serif;background:#f2f6fb;margin:0;display:flex;align-items:center;justify-content:center;height:100vh}
        .container{width:360px;background:#fff;border-radius:8px;box-shadow:0 6px 24px rgba(16,24,40,.08);padding:20px}
        .tabs{display:flex;gap:8px;margin-bottom:14px}
        .tabs button{flex:1;padding:8px 10px;border-radius:6px;border:1px solid #e6edf6;background:#f7fbff;color:#034;cursor:pointer}
        .tabs button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
        .auth-form{display:flex;flex-direction:column;gap:10px}
        .auth-form h2{margin:6px 0 0 0;font-size:20px}
        input[type="text"],input[type="email"],input[type="password"]{padding:10px;border:1px solid #dbe7f5;border-radius:6px;width:100%;font-size:14px}
        .row{display:flex;gap:8px;align-items:center}
        .pw-wrap{position:relative;width:100%}
        .toggle-pw{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:none;color:#666;cursor:pointer}
        button[type=submit]{padding:10px;border-radius:6px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
        .message-area{padding:8px 10px;border-radius:6px;margin-bottom:8px;display:none}
        .message-area.success{background:rgba(47,133,90,.08);color:var(--success);border:1px solid rgba(47,133,90,.12);display:block}
        .message-area.error{background:rgba(229,62,62,.06);color:var(--danger);border:1px solid rgba(229,62,62,.12);display:block}
        .meta{font-size:13px;color:#556;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .meta label{display:flex;gap:6px;align-items:center}
        .small{font-size:12px;color:#667}
        .disabled{opacity:.6;pointer-events:none}
    </style>
</head>
<body>
    <div class="container">
        <div id="message" class="message-area"></div>

        <div class="meta">
            <div class="small">Secure Auth Demo</div>
        </div>

        <div id="authStatus" class="meta" style="display:none;justify-content:flex-end;gap:12px;align-items:center;">
            <div class="small" id="signedInAs"></div>
            <button id="logoutBtn" style="padding:6px 10px;border-radius:6px;border:1px solid #e6edf6;background:#fff;cursor:pointer">Logout</button>
        </div>

        <div class="tabs" role="tablist">
            <button class="active" data-tab="login">Login</button>
            <button data-tab="register">Sign Up</button>
        </div>

        <form id="loginForm" class="auth-form" data-form="login">
            <h2>Login</h2>
            <input type="email" id="loginEmail" placeholder="Email" required>
            <div class="pw-wrap">
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button type="button" class="toggle-pw" data-target="loginPassword">Show</button>
            </div>
            <button type="submit">Log In</button>
        </form>

        <form id="registerForm" class="auth-form" data-form="register" style="display:none;">
            <h2>Sign Up</h2>
            <input type="text" id="registerUsername" placeholder="Username" required>
            <input type="email" id="registerEmail" placeholder="Email" required>
            <div class="pw-wrap">
                <input type="password" id="registerPassword" placeholder="Password" required>
                <button type="button" class="toggle-pw" data-target="registerPassword">Show</button>
            </div>
            <button type="submit">Register</button>
        </form>
    </div>

    <script>
    const BACKEND_URL = 'http://localhost:3000/api/auth';
    const $ = id => document.getElementById(id);

    // CSRF: fetch token on load (server sets secret in cookie); token must be sent in X-CSRF-Token header
    let CSRF_TOKEN = null;
    async function fetchCsrfToken() {
        try {
            const resp = await fetch(`${BACKEND_URL}/csrf-token`, { credentials: 'include' });
            if (resp.ok) {
                const body = await resp.json();
                CSRF_TOKEN = body.csrfToken || resp.headers.get('X-CSRF-Token');
            }
        } catch (e) {
            console.warn('CSRF token unavailable:', e);
        }
    }

        function displayMessage(type, text, timeout = 4000) {
            const msgEl = $('message');
            msgEl.textContent = text;
            msgEl.className = `message-area ${type}`;
            msgEl.style.display = 'block';
            if (timeout) {
                clearTimeout(msgEl._hideTimeout);
                msgEl._hideTimeout = setTimeout(() => { msgEl.style.display = 'none'; }, timeout);
            }
        }

        function clearMessage() {
            const msgEl = $('message');
            msgEl.textContent = '';
            msgEl.className = 'message-area';
            msgEl.style.display = 'none';
        }

        // Tab switching (uses data-tab attributes)
        function setActiveTab(tabName) {
            document.querySelectorAll('.tabs button').forEach(b => b.classList.toggle('active', b.dataset.tab === tabName));
            document.querySelectorAll('form[data-form]').forEach(f => f.style.display = (f.dataset.form === tabName) ? 'flex' : 'none');
            clearMessage();
        }

        document.querySelectorAll('.tabs button').forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));

        // Password show/hide toggles
        document.querySelectorAll('.toggle-pw').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = $(btn.dataset.target);
                if (!target) return;
                if (target.type === 'password') { target.type = 'text'; btn.textContent = 'Hide'; }
                else { target.type = 'password'; btn.textContent = 'Show'; }
            });
        });



        function setFormDisabled(form, disabled) {
            const btn = form.querySelector('button[type=submit]');
            if (btn) {
                if (!btn.dataset.orig) btn.dataset.orig = btn.textContent;
                btn.textContent = disabled ? 'Please wait...' : btn.dataset.orig;
                btn.disabled = disabled;
                btn.classList.toggle('disabled', disabled);
            }
            Array.from(form.elements).forEach(el => { if (el.type !== 'checkbox') el.disabled = disabled; });
        }

        // Registration
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const username = $('registerUsername').value.trim();
            const email = $('registerEmail').value.trim();
            const password = $('registerPassword').value;

            if (username.length < 3) { displayMessage('error', 'Username must be at least 3 characters'); return; }
            if (password.length < 6) { displayMessage('error', 'Password must be at least 6 characters'); return; }

            setFormDisabled(form, true);
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (CSRF_TOKEN) headers['X-CSRF-Token'] = CSRF_TOKEN;
                const response = await fetch(`${BACKEND_URL}/register`, {
                    method: 'POST', headers, credentials: 'include',
                    body: JSON.stringify({ username, email, password })
                });
                const data = await response.json();
                if (response.ok) {
                    displayMessage('success', data.message || 'Registration successful! Please log in.');
                    setActiveTab('login');
                    form.reset();
                } else {
                    displayMessage('error', data.message || 'Registration failed');
                }
            } catch (err) {
                console.error('Network Error:', err);
                displayMessage('error', 'Network error. Could not reach server.');
            } finally {
                setFormDisabled(form, false);
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const email = $('loginEmail').value.trim();
            const password = $('loginPassword').value;

            if (!email || !password) { displayMessage('error', 'Please enter email and password'); return; }

            setFormDisabled(form, true);
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (CSRF_TOKEN) headers['X-CSRF-Token'] = CSRF_TOKEN;
                const response = await fetch(`${BACKEND_URL}/login`, {
                    method: 'POST', headers, credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (response.ok) {
                    // Token is stored as an HttpOnly cookie by the server; do not store tokens in localStorage
                    displayMessage('success', `Welcome back, ${data.username || ''}! Redirecting...`, 2000);
                    setTimeout(() => { window.location.href = 'main web page.html'; }, 1200);
                } else {
                    displayMessage('error', data.message || 'Login failed. Check your credentials.');
                }
            } catch (err) {
                console.error('Network Error:', err);
                displayMessage('error', 'Network error. Could not reach server.');
            } finally {
                setFormDisabled(form, false);
            }
        });

        // Auth status helpers
        function showAuthStatus(username) {
            document.getElementById('signedInAs').textContent = `Signed in as ${username}`;
            document.getElementById('authStatus').style.display = 'flex';
            // hide forms when signed in
            document.querySelectorAll('form[data-form]').forEach(f => f.style.display = 'none');
            document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        }

        function clearAuthStatus() {
            document.getElementById('signedInAs').textContent = '';
            document.getElementById('authStatus').style.display = 'none';
            // show login form by default
            setActiveTab('login');
        }

        async function checkAuthStatus() {
            try {
                const resp = await fetch(`${BACKEND_URL}/me`, { credentials: 'include' });
                if (resp.ok) {
                    const json = await resp.json();
                    if (json && json.user && json.user.username) {
                        showAuthStatus(json.user.username);
                        return true;
                    }
                }
            } catch (e) {
                // ignore; not authenticated or server offline
            }
            clearAuthStatus();
            return false;
        }

        // Logout handler
        document.addEventListener('click', async (ev) => {
            if (ev.target && ev.target.id === 'logoutBtn') {
                try {
                    const headers = {};
                    if (CSRF_TOKEN) headers['X-CSRF-Token'] = CSRF_TOKEN;
                    const resp = await fetch(`${BACKEND_URL}/logout`, { method: 'POST', credentials: 'include', headers });
                    if (resp.ok) {
                        displayMessage('success', 'Logged out');
                        clearAuthStatus();
                    } else {
                        displayMessage('error', 'Could not log out');
                    }
                } catch (err) {
                    console.error('Logout error', err);
                    displayMessage('error', 'Network error on logout');
                }
            }
        });

        // Initialize
        // Fetch CSRF token (best-effort), then check auth status, then show UI
        fetchCsrfToken().then(() => checkAuthStatus()).finally(() => setActiveTab('login'));
    </script>
</body>
</html>